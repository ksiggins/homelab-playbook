---
- name: Uninstall ArgoCD and clean up resources if present
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  run_once: true
  block:
    - name: Check if argocd namespace exists
      ansible.builtin.command: kubectl get ns argocd
      register: argocd_ns
      failed_when: false
      changed_when: false

    - name: Uninstall ArgoCD resources if namespace exists
      ansible.builtin.command: >-
        kubectl delete all,cm,secret,sa,role,rolebinding,svc,deploy,sts,rs,pod --all -n argocd --ignore-not-found
      when: argocd_ns.rc == 0
      changed_when: false

    - name: Delete ArgoCD CRDs if they exist
      ansible.builtin.shell: |-
        set -o pipefail
        for crd in applications.argoproj.io appprojects.argoproj.io applicationsets.argoproj.io; do
          kubectl get crd "$crd" >/dev/null 2>&1 && kubectl delete crd "$crd" || true
        done
      args:
        executable: /bin/bash
      changed_when: false

    - name: Delete argocd namespace if present
      ansible.builtin.command: kubectl delete ns argocd --ignore-not-found
      changed_when: false
