---
- name: Uninstall Argo CD and all managed resources
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  run_once: true
  block:

    - name: Disable Argo CD automation before teardown
      ansible.builtin.shell: |-
        kubectl -n argocd scale deployment argocd-application-controller \
          --replicas=0 || true
        kubectl -n argocd scale deployment argocd-repo-server \
          --replicas=0 || true
      args:
        executable: /bin/bash
      changed_when: false

    - name: Check if Argo CD namespace exists
      ansible.builtin.command: kubectl get ns argocd
      register: argocd_ns
      failed_when: false
      changed_when: false

    - name: Delete Argo CD Applications recursively (children first, non-blocking)
      ansible.builtin.shell: |-
        set -o pipefail
        for app in $(kubectl get applications.argoproj.io -n argocd \
          --no-headers 2>/dev/null | awk '{print $1}' | grep -v '^root$'); do
          kubectl delete application "$app" -n argocd \
            --cascade=true --ignore-not-found --timeout=5s || true
        done
        kubectl delete application root -n argocd \
          --cascade=true --ignore-not-found --timeout=5s || true
      args:
        executable: /bin/bash
      when: argocd_ns.rc == 0
      changed_when: false

    - name: Force remove stuck Argo CD application finalizers
      ansible.builtin.shell: |-
        set -o pipefail
        for app in $(kubectl get applications.argoproj.io -n argocd \
          --no-headers 2>/dev/null | awk '{print $1}'); do
          kubectl patch app "$app" -n argocd \
            -p '{"metadata":{"finalizers":[]}}' --type=merge || true
        done
      args:
        executable: /bin/bash
      when: argocd_ns.rc == 0
      changed_when: false

    - name: Delete all Argo CD resources in namespace
      ansible.builtin.command: >-
        kubectl delete all,cm,secret,sa,role,rolebinding,svc,deploy,sts,rs,pod --all
        -n argocd --ignore-not-found
      when: argocd_ns.rc == 0
      changed_when: false

    - name: Delete Argo CD CRDs if they exist
      ansible.builtin.shell: |-
        set -o pipefail
        for crd in applications.argoproj.io appprojects.argoproj.io \
          applicationsets.argoproj.io; do
          kubectl get crd "$crd" >/dev/null 2>&1 && kubectl delete crd "$crd" || true
        done
      args:
        executable: /bin/bash
      changed_when: false

    - name: Delete argocd namespace if present
      ansible.builtin.command: kubectl delete ns argocd --ignore-not-found
      changed_when: false

    - name: Delete leftover Argo CD ClusterRoles, ClusterRoleBindings, and Webhooks
      ansible.builtin.shell: |-
        kubectl delete clusterrole,clusterrolebinding,validatingwebhookconfiguration,mutatingwebhookconfiguration \
        -l app.kubernetes.io/part-of=argocd --ignore-not-found
      args:
        executable: /bin/bash
      changed_when: false
