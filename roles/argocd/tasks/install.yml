---
- name: Install and verify ArgoCD deployment
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  run_once: true
  block:
    - name: Ensure argocd namespace exists
      ansible.builtin.command: >-
        kubectl create namespace {{ argocd_namespace }}
      register: create_ns
      failed_when: create_ns.rc != 0 and 'AlreadyExists' not in create_ns.stderr
      changed_when: "'AlreadyExists' not in create_ns.stderr"

    - name: Deploy ArgoCD manifest
      ansible.builtin.command: >-
        kubectl apply -n {{ argocd_namespace }}
        -f https://raw.githubusercontent.com/argoproj/argo-cd/refs/tags/{{ argocd_version }}/manifests/install.yaml
      changed_when: false

    - name: Patch ArgoCD ConfigMap to enable Kustomize Helm support
      ansible.builtin.shell: |-
        kubectl -n {{ argocd_namespace }} patch configmap argocd-cm \
          --type merge \
          -p '{"data": {"kustomize.buildOptions": "--enable-helm"}}'
      args:
        executable: /bin/bash
      changed_when: false

    - name: Restart ArgoCD repo-server to pick up config change
      ansible.builtin.command: kubectl -n {{ argocd_namespace }} rollout restart deploy/argocd-repo-server
      changed_when: false

    - name: Wait for ArgoCD namespace to have any pods
      ansible.builtin.command: >-
        kubectl get pods -n {{ argocd_namespace }} --no-headers
      register: argocd_pods_check
      retries: 30
      delay: 5
      until: argocd_pods_check.rc == 0 and (argocd_pods_check.stdout | length) > 0
      changed_when: false

    - name: Wait for ArgoCD pods to become ready
      ansible.builtin.command: >-
        kubectl wait --for=condition=ready pods --all -n {{ argocd_namespace }} --timeout=300s
      changed_when: false
