---
- name: Install and verify Argo CD deployment
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  run_once: true
  block:

    - name: Ensure render directory exists
      ansible.builtin.file:
        path: /tmp/argocd-manifests
        state: directory
        mode: '0700'

    - name: Render all Argo CD templates (including sops-age-key)
      ansible.builtin.template:
        src: "{{ item }}"
        dest: "/tmp/argocd-manifests/{{ item | basename }}"
        mode: '0600'
      with_fileglob:
        - "{{ role_path }}/templates/*"

    - name: Apply all Argo CD manifests declaratively
      ansible.builtin.command: kubectl apply -f /tmp/argocd-manifests/
      register: argocd_apply
      changed_when: "'created' in argocd_apply.stdout or 'configured' in argocd_apply.stdout"

    - name: Wait for Argo CD namespace to have any pods
      ansible.builtin.command: >-
        kubectl get pods -n argocd --no-headers
      register: argocd_pods_check
      retries: 30
      delay: 5
      until: argocd_pods_check.rc == 0 and (argocd_pods_check.stdout | length) > 0
      changed_when: false

    - name: Wait for all Argo CD Deployments and StatefulSets to roll out
      ansible.builtin.shell: |-
        set -o pipefail
        for kind in deployment statefulset; do
          for name in $(kubectl -n argocd get $kind -o name 2>/dev/null); do
            echo "Waiting for rollout of $name..."
            kubectl -n argocd rollout status "$name" --timeout=300s || echo "WARN: $name did not finish rollout"
          done
        done
      args:
        executable: /bin/bash
      changed_when: false

    - name: Remove temp manifests
      ansible.builtin.file:
        path: /tmp/argocd-manifests
        state: absent

  rescue:
    - name: Always remove temp manifests on failure
      ansible.builtin.file:
        path: /tmp/argocd-manifests
        state: absent
