---
- name: Generate Argo CD readonly API token from inside cluster
  run_once: true
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  vars:
    argocd_namespace: argocd
    argocd_secret_name: argocd-api-token
  block:

    - name: Find a running Argo CD server pod
      ansible.builtin.command:
        cmd: >-
          kubectl -n {{ argocd_namespace }} get pods
          -l app.kubernetes.io/name=argocd-server
          -o jsonpath='{.items[0].metadata.name}'
      register: server_pod
      changed_when: false

    - name: Log in and generate readonly token inside the Argo CD pod
      ansible.builtin.command:
        cmd: >-
          kubectl -n {{ argocd_namespace }} exec {{ server_pod.stdout }} -- /bin/sh -c "
            yes | argocd login localhost:8080 \
              --username {{ argocd_admin_user }} \
              --password {{ argocd_admin_password }} \
              --insecure \
              --grpc-web >/dev/null &&
            argocd account generate-token --account {{ argocd_readonly_user }}"
      register: token_result
      changed_when: true

    - name: Fail if no token was generated
      ansible.builtin.fail:
        msg: "Failed to generate Argo CD readonly token."
      when: token_result.stdout | trim == ""

    - name: Create or update Kubernetes secret with readonly token
      ansible.builtin.copy:
        dest: "/tmp/{{ argocd_secret_name }}.yaml"
        mode: '0600'
        content: |
          apiVersion: v1
          kind: Secret
          metadata:
            name: {{ argocd_secret_name }}
            namespace: {{ argocd_namespace }}
            annotations:
              reflector.v1.k8s.emberstack.com/reflection-allowed: "true"
          type: Opaque
          stringData:
            api-token: "{{ token_result.stdout | trim }}"
      no_log: true

    - name: Apply Argo CD API token Secret manifest
      ansible.builtin.command:
        cmd: kubectl apply -f /tmp/{{ argocd_secret_name }}.yaml
      changed_when: true
      no_log: true
