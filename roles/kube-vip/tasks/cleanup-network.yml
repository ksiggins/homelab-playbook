---
- name: Ensure stale VIP address is removed from interfaces
  ansible.builtin.shell: |-
    set -o pipefail
    ip -o -4 addr show eth0 | awk '/{{ k3s_registration_address }}/ {print $4}' | while read cidr; do
      ip addr del "$cidr" dev eth0 || true
    done
  failed_when: false
  changed_when: false

- name: Flush stale ARP and routing entries
  ansible.builtin.shell: |-
    ip neigh flush all || true
    ip route flush cache || true
  failed_when: false
  changed_when: false

- name: Reset loopback interface to base state
  ansible.builtin.shell: |-
    ip addr flush dev lo
    ip addr add 127.0.0.1/8 dev lo
  failed_when: false
  changed_when: false
